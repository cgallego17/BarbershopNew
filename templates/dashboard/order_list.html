{% extends 'dashboard/base.html' %}
{% load static humanize %}
{% block title %}Pedidos{% endblock %}
{% block topbar_title %}Pedidos{% endblock %}
{% block extra_css %}{% include 'dashboard/_admin_styles.html' %}{% endblock %}

{% block content %}
<ul class="orders-tabs mb-4">
    <li class="orders-tabs__item">
        <a href="{% url 'core:admin_panel:order_list' %}?tab=activos" class="orders-tabs__link {% if orders_tab == 'activos' %}orders-tabs__link--active{% endif %}">
            <i class="fas fa-shopping-cart me-1"></i> Activos
        </a>
    </li>
    <li class="orders-tabs__item">
        <a href="{% url 'core:admin_panel:order_list' %}?tab=cancelados" class="orders-tabs__link {% if orders_tab == 'cancelados' %}orders-tabs__link--active{% endif %}">
            <i class="fas fa-ban me-1"></i> Cancelados
            {% if orders_cancelled_count %}<span class="orders-tabs__badge">{{ orders_cancelled_count }}</span>{% endif %}
        </a>
    </li>
</ul>

<div class="admin-card mb-4">
    <div class="admin-card__header">
        <h3 class="admin-card__title mb-0"><i class="fas fa-search me-2"></i>Buscar y filtrar</h3>
        {% if request.GET.q or request.GET.status or request.GET.payment_status or request.GET.sort or request.GET.tab or request.GET.date_from or request.GET.date_to or request.GET.filter_state or request.GET.filter_city %}
        <a href="{% url 'core:admin_panel:order_list' %}?tab={{ orders_tab }}" class="admin-card__action">Limpiar filtros</a>
        {% endif %}
    </div>
    <div class="admin-card__body">
        <form method="get" class="admin-form">
            <input type="hidden" name="tab" value="{{ orders_tab }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Buscar</label>
                    <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="#pedido, email, nombre, teléfono">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha desde</label>
                    <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha hasta</label>
                    <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Departamento / Estado</label>
                    <input type="text" name="filter_state" value="{{ request.GET.filter_state }}" class="form-control" placeholder="Ej. Antioquia">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ciudad</label>
                    <input type="text" name="filter_city" value="{{ request.GET.filter_city }}" class="form-control" placeholder="Ej. Medellín">
                </div>
                {% if orders_tab == 'activos' %}
                <div class="col-md-2">
                    <label class="form-label">Estado pedido</label>
                    <select name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendiente</option>
                        <option value="processing" {% if request.GET.status == 'processing' %}selected{% endif %}>Procesando</option>
                        <option value="on_hold" {% if request.GET.status == 'on_hold' %}selected{% endif %}>En espera</option>
                        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completado</option>
                        <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Reembolsado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Pago</label>
                    <select name="payment_status" class="form-select">
                        <option value="">Todos</option>
                        <option value="pending" {% if request.GET.payment_status == 'pending' %}selected{% endif %}>Pendiente</option>
                        <option value="paid" {% if request.GET.payment_status == 'paid' %}selected{% endif %}>Pagado</option>
                        <option value="failed" {% if request.GET.payment_status == 'failed' %}selected{% endif %}>Fallido</option>
                        <option value="refunded" {% if request.GET.payment_status == 'refunded' %}selected{% endif %}>Reembolsado</option>
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <label class="form-label">Ordenar por</label>
                    <select name="sort" class="form-select">
                        <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>Más recientes</option>
                        <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Más antiguos</option>
                        <option value="total" {% if request.GET.sort == 'total' %}selected{% endif %}>Total menor</option>
                        <option value="-total" {% if request.GET.sort == '-total' %}selected{% endif %}>Total mayor</option>
                    </select>
                </div>
                <div class="col-md-2 col-lg-1">
                    <button type="submit" class="admin-btn admin-btn--primary w-100"><i class="fas fa-search"></i> Buscar</button>
                </div>
            </div>
        </form>
        {% if page_obj %}<p class="text-muted small mb-0 mt-2">{{ page_obj.paginator.count }} resultado{{ page_obj.paginator.count|pluralize }}</p>{% endif %}
    </div>
</div>

<div class="admin-card">
    <div class="admin-card__body p-0">
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Pedido</th>
                        <th>Cliente</th>
                        <th>País / Estado / Ciudad</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Pago</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td><strong>{{ order.order_number }}</strong></td>
                        <td>{{ order.billing_first_name }} {{ order.billing_last_name }}<br><small class="text-muted">{{ order.billing_email }}</small></td>
                        <td><small>{{ order.billing_country }}{% if order.billing_state %} · {{ order.billing_state }}{% endif %} · {{ order.billing_city }}</small></td>
                        <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
                        <td>${{ order.total|floatformat:2|intcomma }}</td>
                        <td><span class="admin-badge admin-badge--{{ order.status }}">{{ order.get_status_display }}</span></td>
                        <td>
                            {% if order.payment_status == 'paid' %}
                                <span class="pay-badge pay-badge--paid"><i class="fas fa-check-circle"></i> Pagado</span>
                            {% elif order.payment_status == 'failed' %}
                                <span class="pay-badge pay-badge--failed"><i class="fas fa-times-circle"></i> Fallido</span>
                            {% elif order.payment_status == 'refunded' %}
                                <span class="pay-badge pay-badge--refunded"><i class="fas fa-undo"></i> Reembolsado</span>
                            {% else %}
                                <span class="pay-badge pay-badge--pending"><i class="fas fa-clock"></i> Pendiente</span>
                            {% endif %}
                        </td>
                        <td class="text-end"><div class="admin-actions"><a href="{% url 'core:admin_panel:order_detail' order.pk %}" class="admin-action admin-action--primary">Ver / Editar</a></div></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="admin-table__empty">{% if request.GET.q or request.GET.status or request.GET.payment_status or request.GET.date_from or request.GET.date_to or request.GET.filter_state or request.GET.filter_city %}No se encontraron pedidos con los filtros aplicados. <a href="{% url 'core:admin_panel:order_list' %}?tab={{ orders_tab }}">Limpiar filtros</a>{% else %}{% if orders_tab == 'cancelados' %}No hay pedidos cancelados{% else %}No hay pedidos{% endif %}{% endif %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4 pagination">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">« Anterior</a>{% endif %}
    <span class="current">Pág. {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Siguiente »</a>{% endif %}
</nav>
{% endif %}

<style>
.orders-tabs {
    display: flex;
    gap: 0;
    list-style: none;
    margin: 0;
    padding: 0;
    border-bottom: 2px solid var(--admin-border, #2d3548);
}
.orders-tabs__item { margin: 0; }
.orders-tabs__link {
    display: inline-flex;
    align-items: center;
    padding: 12px 20px;
    color: var(--admin-text-muted, #8892a4);
    text-decoration: none;
    font-weight: 500;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: color .2s, border-color .2s;
}
.orders-tabs__link:hover {
    color: var(--admin-text, #e2e8f0);
}
.orders-tabs__link--active {
    color: var(--admin-accent, #e07a40);
    border-bottom-color: var(--admin-accent, #e07a40);
}
.orders-tabs__badge {
    margin-left: 6px;
    padding: 2px 8px;
    font-size: .75rem;
    font-weight: 600;
    background: rgba(239, 68, 68, .25);
    color: #f87171;
    border-radius: 10px;
}
.pay-badge {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    font-size: .75rem;
    font-weight: 600;
    padding: .25rem .65rem;
    border-radius: 20px;
    white-space: nowrap;
}
.pay-badge--paid {
    background: rgba(34,197,94,.15);
    border: 1px solid rgba(34,197,94,.35);
    color: #4ade80;
}
.pay-badge--failed {
    background: rgba(239,68,68,.12);
    border: 1px solid rgba(239,68,68,.3);
    color: #f87171;
}
.pay-badge--pending {
    background: rgba(234,179,8,.1);
    border: 1px solid rgba(234,179,8,.3);
    color: #fbbf24;
}
.pay-badge--refunded {
    background: rgba(139,92,246,.12);
    border: 1px solid rgba(139,92,246,.3);
    color: #a78bfa;
}
</style>
{% endblock %}
