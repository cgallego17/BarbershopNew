{% extends 'base.html' %}
{% load static humanize l10n %}

{% block title %}Pagar pedido{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}
{% block meta_description %}Finaliza tu compra de forma segura en {{ site_settings.site_name }}. Revisa tus datos, envío y método de pago.{% endblock %}
{% block og_title %}Checkout seguro | {{ site_settings.site_name }}{% endblock %}
{% block og_description %}Completa tu pedido en pocos pasos con total seguridad.{% endblock %}
{% block twitter_title %}Checkout seguro | {{ site_settings.site_name }}{% endblock %}
{% block twitter_description %}Finaliza tu compra de forma rápida y segura.{% endblock %}

{% block extra_css %}
<style>
/* =====================================================================
   CHECKOUT PAGE - Compact
   ===================================================================== */
.co-section { background: #f2f3f5; padding: 24px 0 36px; }

/* ---- Card base ---- */
.co-card {
    background: #fff;
    border-radius: 10px;
    border: 1px solid #e8e8ec;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    padding: 14px 18px;
    margin-bottom: 10px;
}

/* ---- Sección título ---- */
.co-section-title {
    font-size: .6rem; font-weight: 800;
    letter-spacing: .1em; text-transform: uppercase;
    color: var(--boskery-base, #C56533);
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 5px;
}
.co-section-title::after { content: ''; flex: 1; height: 1px; background: #f0f0f4; }
.co-section-title i { opacity: .8; font-size: .75rem; }

/* ---- Campos ---- */
.co-field {
    display: flex; flex-direction: column; gap: 2px;
    margin-bottom: 8px;
}
.co-field:last-child { margin-bottom: 0; }
.co-field label {
    font-size: .65rem; font-weight: 700;
    letter-spacing: .06em; text-transform: uppercase; color: #888;
}
.co-field input,
.co-field select,
.co-field textarea {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #e4e4e8;
    border-radius: 6px;
    font-size: .82rem; color: #222;
    background: #fafafa; outline: none;
    transition: border-color .18s, background .18s;
    font-family: inherit;
    appearance: none;
}
.co-field input:focus,
.co-field select:focus { border-color: var(--boskery-base, #C56533); background: #fff; }
.co-field input::placeholder { color: #bbb; }
.co-radio-option {
    display: flex; align-items: center; gap: 5px;
    padding: 6px 10px; border-radius: 6px;
    border: 1px solid #e4e4e8; background: #fafafa;
    cursor: pointer; font-size: .8rem; font-weight: 600; color: #333;
    transition: border-color .18s, background .18s;
}
.co-radio-option input { margin: 0; }
.co-radio-option:has(input:checked) { border-color: var(--boskery-base, #C56533); background: rgba(197,101,51,.06); }
.co-person-only { transition: opacity .2s; }
.co-person-only.co-hidden { display: none !important; }
.co-field select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 12 8'%3E%3Cpath fill='%23aaa' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 32px;
}

.co-coupon-section {
    border-top: 1px dashed #e4e4e8;
    margin: 4px 0 2px;
    padding-top: 4px;
}
.co-coupon-toggle {
    width: 100%; background: none; border: none; cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    padding: 6px 2px; color: #666; font-size: .78rem; font-weight: 600;
    font-family: inherit; text-align: left;
    transition: color .18s;
}
.co-coupon-toggle:hover { color: var(--boskery-base, #C56533); }
.co-coupon-toggle i:first-child { color: var(--boskery-base, #C56533); font-size: .8rem; }
.co-coupon-toggle span { flex: 1; }
.co-coupon-chevron { font-size: .6rem; transition: transform .22s; }
.co-coupon-chevron.open { transform: rotate(180deg); }
.co-coupon-body { padding: 6px 0 2px; }

.co-legal-checkboxes {
    margin: 10px 0 12px;
    padding: 10px 0;
    border-top: 1px dashed #e4e4e8;
}
.co-checkbox-row {
    display: flex; align-items: flex-start; gap: 8px;
    cursor: pointer; font-size: .78rem; color: #444;
    margin-bottom: 6px;
}
.co-checkbox-row:last-child { margin-bottom: 0; }
.co-checkbox-row input { margin: 2px 0 0; flex-shrink: 0; }
.co-checkbox-row a {
    color: var(--boskery-base, #C56533);
    text-decoration: underline;
}
.co-checkbox-row a:hover { text-decoration: none; }

.co-coupon-row { display: flex; gap: 8px; }
.co-coupon-input-wrap { position: relative; flex: 1; }
.co-coupon-icon {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    color: #ccc; font-size: .8rem; pointer-events: none;
}
.co-coupon-input-wrap input {
    width: 100%; padding: 8px 12px 8px 34px;
    border: 1px solid #e4e4e8; border-radius: 8px;
    font-size: .85rem; color: #222; background: #fafafa;
    outline: none; font-family: inherit; letter-spacing: .05em; font-weight: 600;
    transition: border-color .18s, background .18s;
}
.co-coupon-input-wrap input::placeholder { color: #c0c0c6; font-weight: 400; }
.co-coupon-input-wrap input:focus { border-color: var(--boskery-base,#C56533); background: #fff; }
.co-coupon-input-wrap:focus-within .co-coupon-icon { color: var(--boskery-base,#C56533); }
.co-coupon-btn {
    padding: 8px 16px; border-radius: 8px;
    border: 1px solid var(--boskery-base, #C56533);
    background: transparent; color: var(--boskery-base, #C56533);
    font-size: .8rem; font-weight: 700; cursor: pointer;
    white-space: nowrap; flex-shrink: 0;
    transition: background .18s, color .18s;
}
.co-coupon-btn:hover { background: var(--boskery-base, #C56533); color: #fff; }
.co-coupon-btn:disabled { opacity: .5; cursor: default; }

.co-coupon-msg {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 12px; border-radius: 8px;
    font-size: .8rem; font-weight: 600;
}
.co-coupon-msg--error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.co-coupon-msg--success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

.co-coupon-tag {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 16px;
    background: rgba(34,197,94,.08); border: 1px solid rgba(34,197,94,.3);
    color: #16a34a; font-size: .8rem; font-weight: 700;
}
.co-coupon-tag button { background: none; border: none; cursor: pointer; color: #16a34a; font-size: .65rem; padding: 0; opacity: .7; }

/* Spinner en botón */
.co-coupon-btn .fa-spinner { display: none; }
.co-coupon-btn.loading .fa-spinner { display: inline-block; }
.co-coupon-btn.loading .btn-text { display: none; }

.co-steps { display: flex; align-items: center; gap: 0; margin-bottom: 20px; }
.co-step { display: flex; align-items: center; gap: 6px; font-size: .72rem; font-weight: 700; color: #bbb; }
.co-step__num {
    width: 24px; height: 24px; border-radius: 50%;
    background: #ebebeb; color: #aaa;
    display: flex; align-items: center; justify-content: center;
    font-size: .65rem; font-weight: 800; flex-shrink: 0;
}
.co-step.active .co-step__num { background: var(--boskery-base, #C56533); color: #fff; }
.co-step.active { color: #1a1a1a; }
.co-step.done .co-step__num { background: #22c55e; color: #fff; }
.co-step-line { flex: 1; height: 1px; background: #e8e8ec; margin: 0 8px; }

.co-order-items { margin-bottom: 12px; max-height: 180px; overflow-y: auto; }
.co-order-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #f5f5f8;
}
.co-order-item:last-child { border-bottom: none; }
.co-order-item__img {
    position: relative; flex-shrink: 0;
    width: 42px; height: 42px; border-radius: 6px;
    border: 1px solid #f0f0f4;
}
.co-order-item__img img {
    width: 100%; height: 100%; object-fit: cover;
    border-radius: 6px; display: block;
}
.co-order-item__qty-badge {
    position: absolute; top: -4px; right: -4px;
    width: 14px; height: 14px; border-radius: 50%;
    background: var(--boskery-base, #C56533); color: #fff;
    font-size: .55rem; font-weight: 800;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff;
}
.co-order-item__name {
    flex: 1; font-size: .78rem; font-weight: 700; color: #1a1a1a;
    text-decoration: none; line-height: 1.2;
}
.co-order-item__name:hover { color: var(--boskery-base, #C56533); }
.co-order-item__price { font-size: .8rem; font-weight: 700; color: #555; flex-shrink: 0; }

.co-total-rows { border-top: 1px solid #f0f0f4; padding-top: 10px; }
.co-total-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 5px 0; font-size: .82rem; color: #666;
    border-bottom: 1px dashed #f5f5f8;
}
.co-total-row:last-of-type { border-bottom: none; }
.co-total-row span:last-child { font-weight: 700; color: #1a1a1a; }
.co-grand-total {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 0 14px; border-top: 2px solid #f0f0f4; margin-top: 4px;
}
.co-grand-total__label { font-size: .95rem; font-weight: 700; color: #1a1a1a; }
.co-grand-total__val { font-size: 1.2rem; font-weight: 900; color: var(--boskery-base, #C56533); }

.co-btn-confirm {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 12px;
    background: var(--boskery-base, #C56533); color: #fff;
    border: none; border-radius: 10px;
    font-size: .95rem; font-weight: 800; cursor: pointer;
    box-shadow: 0 4px 16px rgba(197,101,51,.28);
    transition: background .2s, box-shadow .2s, transform .15s;
}
.co-btn-confirm:hover { background: #a34120; box-shadow: 0 6px 20px rgba(197,101,51,.38); transform: translateY(-1px); }

.co-secure-note { margin-top: 8px; font-size: .7rem; color: #bbb; text-align: center; }
.co-back-link {
    display: inline-flex; align-items: center; gap: 5px;
    color: #aaa; font-size: .75rem; text-decoration: none;
    margin-top: 8px; transition: color .18s;
}
.co-back-link:hover { color: var(--boskery-base, #C56533); }

@media (max-width: 575px) {
    .co-section { padding: 20px 0 28px; }
    .co-card { padding: 14px 16px; margin-bottom: 8px; }
    .co-steps { margin-bottom: 14px; }
}

/* ---- Auth block (login / cuenta) ---- */
.co-auth-block {
    background: #fff;
    border-radius: 10px;
    border: 1px solid #e8e8ec;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
    overflow: hidden;
}
.co-auth-tabs {
    display: flex;
    border-bottom: 1px solid #f0f0f4;
}
.co-auth-tab {
    flex: 1; padding: 10px 14px;
    background: none; border: none; cursor: pointer;
    font-size: .78rem; font-weight: 700; color: #999;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: color .18s, background .18s;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    font-family: inherit;
}
.co-auth-tab:hover { color: var(--boskery-base,#C56533); background: #fdf8f5; }
.co-auth-tab--active { color: var(--boskery-base,#C56533); border-bottom-color: var(--boskery-base,#C56533); background: #fdf8f5; }
.co-auth-panel { padding: 14px 18px; }
.co-auth-hint { font-size: .78rem; color: #999; margin: 0 0 10px; }
.co-auth-form .co-field input { background: #fafafa; }
.co-auth-submit {
    padding: 7px 14px; border-radius: 6px;
    background: var(--boskery-base,#C56533); color: #fff;
    border: none; font-size: .8rem; font-weight: 700;
    cursor: pointer; font-family: inherit;
    transition: background .18s;
    white-space: nowrap;
}
.co-auth-submit:hover { background: #a34120; }
.co-auth-links { margin-top: 8px; font-size: .73rem; color: #aaa; display: flex; gap: 6px; flex-wrap: wrap; }
.co-auth-links a { color: var(--boskery-base,#C56533); text-decoration: none; }
.co-auth-links a:hover { text-decoration: underline; }
.co-auth-sep { color: #ddd; }
.co-eye-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    background: none; border: none; cursor: pointer; color: #bbb;
    font-size: .8rem; padding: 0; line-height: 1;
}
.co-eye-btn:hover { color: #666; }
/* ---- Tarjeta crear cuenta ---- */
.co-signup-card {
    margin-top: 10px;
    border-radius: 10px;
    border: 1.5px dashed rgba(197,101,51,.45);
    background: linear-gradient(135deg, #fffaf7 0%, #fff8f4 100%);
    overflow: hidden;
    transition: border-color .2s, box-shadow .2s;
}
.co-signup-card:focus-within,
.co-signup-card:has(#co-create-account-fields:not([style*="display:none"])) {
    border-color: var(--boskery-base,#C56533);
    border-style: solid;
    box-shadow: 0 4px 18px rgba(197,101,51,.12);
}
.co-signup-card__head {
    width: 100%; background: none; border: none; cursor: pointer;
    display: flex; align-items: center; gap: 10px;
    padding: 12px 14px; text-align: left;
    font-family: inherit;
    transition: background .15s;
}
.co-signup-card__head:hover { background: rgba(197,101,51,.05); }
.co-signup-card__icon {
    flex-shrink: 0;
    width: 34px; height: 34px; border-radius: 50%;
    background: rgba(197,101,51,.12);
    border: 1.5px solid rgba(197,101,51,.25);
    display: flex; align-items: center; justify-content: center;
    color: var(--boskery-base,#C56533); font-size: .85rem;
}
.co-signup-card__text { flex: 1; min-width: 0; }
.co-signup-card__title {
    display: block;
    font-size: .8rem; font-weight: 800; color: #1a1a1a;
    letter-spacing: .01em;
}
.co-signup-card__sub {
    display: block;
    font-size: .67rem; color: #888; margin-top: 1px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.co-signup-card__toggle-icon {
    flex-shrink: 0; color: #bbb; font-size: .7rem;
    transition: transform .22s;
}
.co-signup-card__toggle-icon.open { transform: rotate(180deg); }
.co-signup-card__benefits {
    display: flex; gap: 6px; flex-wrap: wrap;
    padding: 0 14px 10px;
}
.co-signup-benefit {
    display: inline-flex; align-items: center; gap: 5px;
    background: rgba(197,101,51,.08); border: 1px solid rgba(197,101,51,.18);
    color: #a04d22; border-radius: 20px;
    font-size: .67rem; font-weight: 700; padding: 3px 9px;
}
.co-signup-benefit i { font-size: .6rem; }
.co-signup-card__body { padding: 0 14px 12px; }
.co-signup-card__divider {
    height: 1px; background: rgba(197,101,51,.15);
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<section class="page-header">
    <div class="page-header__bg" style="background-image: url({% static 'assets/images/backgrounds/page-header-bg.jpg' %});"></div>
    <div class="container">
        <h2 class="page-header__title">Finalizar pedido</h2>
        <ul class="boskery-breadcrumb list-unstyled">
            <li><a href="{% url 'core:home' %}">Inicio</a></li>
            <li><a href="{% url 'cart:detail' %}">Carrito</a></li>
            <li><span>Pagar</span></li>
        </ul>
    </div>
</section>

<section class="co-section">
    <div class="container">

        <!-- Pasos -->
        <div class="co-steps">
            <div class="co-step done">
                <div class="co-step__num"><i class="fas fa-check" style="font-size:.6rem"></i></div>
                <span>Carrito</span>
            </div>
            <div class="co-step-line"></div>
            <div class="co-step active">
                <div class="co-step__num">2</div>
                <span>Datos</span>
            </div>
            <div class="co-step-line"></div>
            <div class="co-step">
                <div class="co-step__num">3</div>
                <span>Confirmación</span>
            </div>
        </div>

        {# ── Bloque login / cuenta (solo invitados) ────────────────────── #}
        {% if not user.is_authenticated %}
        <div class="co-auth-block mb-3" id="co-auth-block">
            <div class="co-auth-tabs">
                <button type="button" class="co-auth-tab co-auth-tab--active" id="co-tab-login" onclick="coAuthSwitch('login')">
                    <i class="fas fa-sign-in-alt"></i> Ya tengo cuenta
                </button>
                <button type="button" class="co-auth-tab" id="co-tab-guest" onclick="coAuthSwitch('guest')">
                    <i class="fas fa-user-circle"></i> Continuar como invitado
                </button>
            </div>

            <!-- Panel: Iniciar sesión -->
            <div id="co-auth-login" class="co-auth-panel">
                <p class="co-auth-hint">Inicia sesión para que tus datos se completen automáticamente.</p>
                <form method="post" action="{% url 'account_login' %}?next={% url 'orders:checkout' %}" class="co-auth-form">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-sm-5">
                            <div class="co-field mb-0">
                                <label for="co-login-email">Email</label>
                                <input type="email" id="co-login-email" name="login" required autocomplete="email" placeholder="tu@email.com">
                            </div>
                        </div>
                        <div class="col-sm-5">
                            <div class="co-field mb-0">
                                <label for="co-login-pass">Contraseña</label>
                                <div style="position:relative;">
                                    <input type="password" id="co-login-pass" name="password" required autocomplete="current-password" placeholder="••••••••" style="padding-right:36px;">
                                    <button type="button" class="co-eye-btn" onclick="coTogglePwd('co-login-pass',this)" tabindex="-1" aria-label="Ver contraseña">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-2 d-flex align-items-end">
                            <button type="submit" class="co-auth-submit w-100">Entrar</button>
                        </div>
                    </div>
                    <div class="co-auth-links">
                        <a href="{% url 'account_reset_password' %}">¿Olvidaste tu contraseña?</a>
                        <span class="co-auth-sep">·</span>
                        <a href="{% url 'account_signup' %}?next={% url 'orders:checkout' %}">Crear cuenta nueva</a>
                    </div>
                </form>
            </div>

            <!-- Panel: invitado (oculto por defecto) -->
            <div id="co-auth-guest" class="co-auth-panel" style="display:none;">
                <p class="co-auth-hint">Completa tus datos abajo. Al final puedes guardar tu cuenta opcionalmente.</p>
            </div>
        </div>
        {% endif %}

        <form method="post" id="checkout-form">
            {% csrf_token %}
            <div class="row gutter-y-20">

                <!-- ============ FORMULARIO ============ -->
                <div class="col-lg-7 col-xl-8">

                    <!-- Tipo de comprador y Datos personales -->
                    <div class="co-card">
                        <p class="co-section-title"><i class="fas fa-id-card"></i> Datos de facturación</p>
                        <div class="row g-0 mb-2">
                            <div class="col-6 pe-2">
                                <label class="co-radio-option">
                                    <input type="radio" name="billing_customer_type" value="person" {% if not user.is_authenticated or user.customer_type == 'person' %}checked{% endif %}>
                                    <span>Persona natural</span>
                                </label>
                            </div>
                            <div class="col-6 ps-2">
                                <label class="co-radio-option">
                                    <input type="radio" name="billing_customer_type" value="company" {% if user.is_authenticated and user.customer_type == 'company' %}checked{% endif %}>
                                    <span>Empresa</span>
                                </label>
                            </div>
                        </div>
                        <div class="row g-0">
                            <div class="col-md-6 pe-md-2">
                                <div class="co-field">
                                    <label for="co-doctype">Tipo doc *</label>
                                    <select id="co-doctype" name="billing_document_type" required autocomplete="off" data-initial-doctype="{% if user.is_authenticated %}{{ user.document_type|default:'' }}{% endif %}">
                                        <option value="">Seleccione…</option>
                                        <option value="CC" {% if user.is_authenticated and user.document_type == 'CC' %}selected{% endif %}>Cédula ciudadanía</option>
                                        <option value="CE" {% if user.is_authenticated and user.document_type == 'CE' %}selected{% endif %}>Cédula extranjería</option>
                                        <option value="PA" {% if user.is_authenticated and user.document_type == 'PA' %}selected{% endif %}>Pasaporte</option>
                                        <option value="NIT" {% if user.is_authenticated and user.customer_type == 'company' or user.is_authenticated and user.document_type == 'NIT' %}selected{% endif %}>NIT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 ps-md-2">
                                <div class="co-field">
                                    <label for="co-document">Nº identificación *</label>
                                    <input type="text" id="co-document" name="billing_document_number" required autocomplete="off"
                                           value="{% if user.is_authenticated %}{{ user.document_number|default:'' }}{% endif %}">
                                </div>
                            </div>
                            <div id="co-person-birth-wrap" class="col-md-6 pe-md-2 co-person-only">
                                <div class="co-field">
                                    <label for="co-birth">Nacimiento</label>
                                    <input type="date" id="co-birth" name="billing_date_of_birth" autocomplete="bday"
                                           value="{% if user.is_authenticated %}{{ user.date_of_birth|date:'Y-m-d'|default:'' }}{% endif %}" placeholder="dd/mm/aaaa">
                                </div>
                            </div>
                        </div>
                        <div class="row g-0">
                            <div class="col-md-6 pe-md-2">
                                <div class="co-field">
                                    <label for="co-fname">Nombre *</label>
                                    <input type="text" id="co-fname" name="billing_first_name" required autocomplete="given-name"
                                           value="{% if user.is_authenticated %}{{ user.first_name|default:'' }}{% endif %}" placeholder="Tu nombre">
                                </div>
                            </div>
                            <div id="co-person-lname-wrap" class="col-md-6 ps-md-2 co-person-only">
                                <div class="co-field">
                                    <label for="co-lname">Apellido *</label>
                                    <input type="text" id="co-lname" name="billing_last_name" autocomplete="family-name"
                                           value="{% if user.is_authenticated %}{{ user.last_name|default:'' }}{% endif %}" placeholder="Tu apellido">
                                </div>
                            </div>
                            <div class="col-md-7 pe-md-2">
                                <div class="co-field">
                                    <label for="co-email">Email *</label>
                                    <input type="email" id="co-email" name="billing_email" required autocomplete="email"
                                           value="{% if user.is_authenticated %}{{ user.email|default:'' }}{% endif %}" placeholder="tu@email.com">
                                </div>
                            </div>
                            <div class="col-md-5 ps-md-2">
                                <div class="co-field">
                                    <label for="co-phone">Teléfono</label>
                                    <input type="tel" id="co-phone" name="billing_phone" autocomplete="tel"
                                           value="{% if user.is_authenticated %}{{ user.phone|default:'' }}{% endif %}" placeholder="(+57) 300 000 0000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dirección -->
                    <div class="co-card">
                        <p class="co-section-title"><i class="fas fa-map-marker-alt"></i> Dirección de envío</p>
                        <div class="co-field">
                            <label for="co-address">Dirección *</label>
                            <input type="text" id="co-address" name="billing_address" required autocomplete="street-address"
                                   value="{{ checkout_prefill.address|default:'' }}" placeholder="Calle, número, barrio…">
                        </div>
                        <div class="row g-0 js-geo-cascade"
                             data-country-name="billing_country"
                             data-state-name="billing_state"
                             data-city-name="billing_city">
                            <div class="col-md-4 pe-md-2">
                                <div class="co-field">
                                    <label>País *</label>
                                    <select name="billing_country" required autocomplete="country-name">
                                        <option value="">Selecciona país…</option>
                                        {% for c in countries %}
                                        <option value="{{ c.name }}"
                                            {% if checkout_prefill.country == c.name or not user.is_authenticated and c.name == 'Colombia' %}selected{% endif %}>
                                            {{ c.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 px-md-2">
                                <div class="co-field">
                                    <label>Departamento</label>
                                    <select name="billing_state" autocomplete="address-level1">
                                        <option value="">Selecciona…</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 ps-md-2">
                                <div class="co-field">
                                    <label>Ciudad *</label>
                                    <select name="billing_city" required autocomplete="address-level2">
                                        <option value="">Selecciona…</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row g-0">
                            <div class="col-md-4">
                                <div class="co-field">
                                    <label for="co-postal">Código postal</label>
                                    <input type="text" id="co-postal" name="billing_postal_code" autocomplete="postal-code"
                                           value="{{ checkout_prefill.postal_code|default:'' }}" placeholder="000000">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- ============ RESUMEN ============ -->
                <div class="col-lg-5 col-xl-4">
                    <div class="co-card" style="position:sticky;top:90px;">
                        <p class="co-section-title"><i class="fas fa-shopping-bag"></i> Tu pedido</p>

                        <!-- Items -->
                        <div class="co-order-items">
                            {% for item in cart %}
                            <div class="co-order-item">
                                <div class="co-order-item__img">
                                    {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" loading="lazy">
                                    {% else %}
                                    <img src="{% static 'assets/images/products/product-1-1.png' %}" alt="{{ item.product.name }}">
                                    {% endif %}
                                    <span class="co-order-item__qty-badge">{{ item.quantity }}</span>
                                </div>
                                <a href="{{ item.product.get_absolute_url }}" class="co-order-item__name">{{ item.product.name }}{% if item.variant %} <span style="font-weight:400;color:#aaa;font-size:.75rem">· {{ item.variant.attributes_display }}</span>{% endif %}</a>
                                <span class="co-order-item__price">{{ site_settings.currency }}{{ item.total_price|floatformat:0|intcomma }}</span>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Totales -->
                        <div class="co-total-rows">
                            <div class="co-total-row">
                                <span>Subtotal</span>
                                <span id="co-subtotal-val">{{ site_settings.currency }}{{ cart_total|floatformat:0|intcomma }}</span>
                            </div>
                            <div class="co-total-row" id="co-discount-row" style="display:none;">
                                <span style="color:#16a34a;font-weight:600;display:flex;align-items:center;gap:5px;">
                                    <i class="fas fa-tag" style="font-size:.7rem;"></i> Descuento
                                </span>
                                <span id="co-discount-val" style="color:#16a34a;font-weight:700;"></span>
                            </div>
                            <div class="co-total-row" id="co-shipping-row">
                                <span>Envío</span>
                                <span id="co-shipping-val" style="color:#22c55e;font-weight:700;">Selecciona ciudad</span>
                            </div>
                        </div>

                        <!-- Cupón (integrado en resumen) -->
                        <div class="co-coupon-section">
                            <button type="button" class="co-coupon-toggle" id="coupon-toggle-btn">
                                <i class="fas fa-ticket-alt"></i>
                                <span id="coupon-toggle-text">¿Tienes un cupón?</span>
                                <i class="fas fa-chevron-down co-coupon-chevron" id="coupon-chevron"></i>
                            </button>
                            <div class="co-coupon-body" id="coupon-body" style="display:none;">
                                <div class="co-coupon-row" id="coupon-input-row">
                                    <div class="co-coupon-input-wrap">
                                        <i class="fas fa-ticket-alt co-coupon-icon"></i>
                                        <input type="text" id="coupon-input" name="coupon_code"
                                               placeholder="Ej: descuento10"
                                               autocomplete="off" autocapitalize="off">
                                    </div>
                                    <button type="button" class="co-coupon-btn" id="coupon-apply-btn">
                                        <span class="btn-text">Aplicar</span>
                                    </button>
                                </div>
                                <div id="coupon-feedback" style="display:none;margin-top:10px;"></div>
                                <div id="coupon-applied" style="display:none;margin-top:10px;"></div>
                            </div>
                        </div>

                        <div class="co-grand-total">
                            <span class="co-grand-total__label">Total</span>
                            <span class="co-grand-total__val" id="co-total-val">{{ site_settings.currency }}{{ cart_total|floatformat:0|intcomma }}</span>
                        </div>

                        <!-- Crear cuenta opcional (solo invitados) -->
                        {% if not user.is_authenticated %}
                        <div class="co-signup-card" id="co-create-account-section">
                            <!-- Cabecera clickeable -->
                            <button type="button" class="co-signup-card__head" id="co-create-account-toggle"
                                    onclick="coToggleCreateAccount(this)" aria-expanded="false">
                                <div class="co-signup-card__icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="co-signup-card__text">
                                    <span class="co-signup-card__title">Crea tu cuenta gratis</span>
                                    <span class="co-signup-card__sub">Historial de pedidos · Datos guardados · Más rápido la próxima vez</span>
                                </div>
                                <div class="co-signup-card__toggle-icon" id="co-signup-chevron">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </button>

                            <!-- Beneficios (siempre visibles cuando está colapsado) -->
                            <div class="co-signup-card__benefits" id="co-signup-benefits">
                                <span class="co-signup-benefit"><i class="fas fa-history"></i> Tus pedidos</span>
                                <span class="co-signup-benefit"><i class="fas fa-map-marker-alt"></i> Dirección guardada</span>
                                <span class="co-signup-benefit"><i class="fas fa-bolt"></i> Compra rápida</span>
                            </div>

                            <!-- Campo contraseña (expandible) -->
                            <div class="co-signup-card__body" id="co-create-account-fields">
                                <div class="co-signup-card__divider"></div>
                                <div class="co-field mb-0">
                                    <label for="co-new-password" style="font-size:.68rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:#777;">
                                        Elige una contraseña
                                    </label>
                                    <div style="position:relative;">
                                        <input type="password" id="co-new-password" name="new_password"
                                               autocomplete="new-password"
                                               placeholder="Mínimo 8 caracteres"
                                               style="padding-right:40px;border-color:rgba(197,101,51,.4);background:#fffaf7;">
                                        <button type="button" class="co-eye-btn" onclick="coTogglePwd('co-new-password',this)" tabindex="-1" aria-label="Ver contraseña">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span style="font-size:.67rem;color:#aaa;margin-top:3px;display:block;">
                                        <i class="fas fa-lock" style="font-size:.6rem;margin-right:3px;"></i>Tu email será el usuario. Puedes cambiar la contraseña luego.
                                    </span>
                                </div>
                                <input type="hidden" name="create_account" id="co-create-account-hidden" value="0">
                            </div>
                        </div>
                        {% endif %}

                        <!-- Aceptación de términos y política -->
                        <div class="co-legal-checkboxes">
                            <label class="co-checkbox-row">
                                <input type="checkbox" name="accept_terms" id="co-accept-terms" required>
                                <span>Acepto los <a href="{{ site_settings.terms_url|default:'#' }}" target="_blank" rel="noopener noreferrer">términos y condiciones</a></span>
                            </label>
                            <label class="co-checkbox-row">
                                <input type="checkbox" name="accept_privacy" id="co-accept-privacy" required>
                                <span>Acepto la <a href="{{ site_settings.privacy_url|default:'#' }}" target="_blank" rel="noopener noreferrer">política de tratamiento de datos</a></span>
                            </label>
                        </div>

                        <!-- Confirmar -->
                        <button type="submit" form="checkout-form" class="co-btn-confirm">
                            <i class="fas fa-lock"></i> Confirmar pedido
                        </button>
                        
                        <!-- Logos de pago para seguridad -->
                        <div class="co-payment-logos" style="margin-top: 12px; text-align: center;">
                            <img src="{% static 'wompi-logos (1).webp' %}" alt="Métodos de pago seguros Wompi" style="max-width: 100%; height: auto; border-radius: 8px; opacity: 0.9;">
                        </div>

                        <p class="co-secure-note"><i class="fas fa-shield-alt"></i> Pago seguro y cifrado</p>
                        <a href="{% url 'cart:detail' %}" class="co-back-link">
                            <i class="fas fa-arrow-left"></i> Volver al carrito
                        </a>
                    </div>
                </div>

            </div>
        </form>
    </div>
</section>

{% include 'dashboard/_geo_cascade_script.html' %}
{% endblock %}

{% block extra_js %}
<script>
/* ── Auth block helpers ─────────────────────────────────────── */
function coAuthSwitch(tab) {
    var loginPanel = document.getElementById('co-auth-login');
    var guestPanel = document.getElementById('co-auth-guest');
    var tabLogin   = document.getElementById('co-tab-login');
    var tabGuest   = document.getElementById('co-tab-guest');
    if (!loginPanel) return;
    if (tab === 'login') {
        loginPanel.style.display = '';
        if (guestPanel) guestPanel.style.display = 'none';
        tabLogin.classList.add('co-auth-tab--active');
        tabGuest.classList.remove('co-auth-tab--active');
        document.getElementById('co-login-email').focus();
    } else {
        loginPanel.style.display = 'none';
        if (guestPanel) guestPanel.style.display = '';
        tabGuest.classList.add('co-auth-tab--active');
        tabLogin.classList.remove('co-auth-tab--active');
    }
}
function coTogglePwd(inputId, btn) {
    var inp = document.getElementById(inputId);
    if (!inp) return;
    var isText = inp.type === 'text';
    inp.type = isText ? 'password' : 'text';
    btn.querySelector('i').className = isText ? 'fas fa-eye' : 'fas fa-eye-slash';
}
function coToggleCreateAccount(btn) {
    var fields  = document.getElementById('co-create-account-fields');
    var hidden  = document.getElementById('co-create-account-hidden');
    var pwdInput= document.getElementById('co-new-password');
    var chevron = document.getElementById('co-signup-chevron');
    var benefits= document.getElementById('co-signup-benefits');
    if (!fields) return;
    var isOpen = fields.style.display !== 'none';
    if (isOpen) {
        fields.style.display = 'none';
        if (hidden) hidden.value = '0';
        if (pwdInput) { pwdInput.required = false; pwdInput.value = ''; }
        if (chevron) chevron.classList.remove('open');
        if (benefits) benefits.style.display = '';
        if (btn) btn.setAttribute('aria-expanded', 'false');
    } else {
        fields.style.display = 'block';
        if (hidden) hidden.value = '1';
        if (pwdInput) { pwdInput.required = true; setTimeout(function(){ pwdInput.focus(); }, 80); }
        if (chevron) chevron.classList.add('open');
        if (benefits) benefits.style.display = 'none';
        if (btn) btn.setAttribute('aria-expanded', 'true');
    }
}
</script>
<script>
(function () {
    var CART_SUBTOTAL = {{ cart_total|unlocalize }};
    var FREE_SHIPPING_MIN = {{ free_shipping_min_amount|default:0|unlocalize }};
    var CURRENCY = "{{ site_settings.currency|escapejs }}";
    var SHIPPING_URL = "{% url 'core:geo_shipping_info' %}";

    function formatMoney(val) {
        return CURRENCY + Math.round(val).toLocaleString('es-CO');
    }

    // Opciones del select tipo de documento: persona (CC, CE, PA) o solo NIT para empresa
    var PERSON_DOCTYPE_OPTIONS = '<option value="">Seleccione…</option><option value="CC">Cédula ciudadanía</option><option value="CE">Cédula extranjería</option><option value="PA">Pasaporte</option>';
    var COMPANY_DOCTYPE_OPTIONS = '<option value="NIT">NIT</option>';

    function toggleCheckoutPersonFields() {
        var personBirth = document.getElementById('co-person-birth-wrap');
        var personLname = document.getElementById('co-person-lname-wrap');
        var doctypeSelect = document.getElementById('co-doctype');
        var lnameInput = document.getElementById('co-lname');
        var birthInput = document.getElementById('co-birth');
        var radios = document.querySelectorAll('input[name="billing_customer_type"]');
        var isCompany = false;
        if (radios.length) {
            for (var i = 0; i < radios.length; i++) { if (radios[i].value === 'company' && radios[i].checked) { isCompany = true; break; } }
        }
        if (personBirth) personBirth.classList.toggle('co-hidden', isCompany);
        if (personLname) personLname.classList.toggle('co-hidden', isCompany);
        if (doctypeSelect) {
            if (isCompany) {
                doctypeSelect.innerHTML = COMPANY_DOCTYPE_OPTIONS;
                doctypeSelect.value = 'NIT';
            } else {
                doctypeSelect.innerHTML = PERSON_DOCTYPE_OPTIONS;
                var current = doctypeSelect.getAttribute('data-initial-doctype') || '';
                if (current && ['CC','CE','PA'].indexOf(current) !== -1) doctypeSelect.value = current;
                else doctypeSelect.value = '';
            }
        }
        if (lnameInput) {
            if (isCompany) { lnameInput.removeAttribute('required'); lnameInput.value = ''; }
            else lnameInput.setAttribute('required', 'required');
        }
        if (birthInput && isCompany) birthInput.value = '';
    }
    toggleCheckoutPersonFields();
    document.getElementById('checkout-form').addEventListener('change', function (e) {
        if (e.target && e.target.name === 'billing_customer_type') toggleCheckoutPersonFields();
    });

    const VALIDATE_URL = "{% url 'orders:validate_coupon' %}";

    const inp      = document.getElementById('coupon-input');
    const applyBtn = document.getElementById('coupon-apply-btn');
    const feedback = document.getElementById('coupon-feedback');
    const appliedEl= document.getElementById('coupon-applied');

    // Resumen totales
    const discountRow = document.getElementById('co-discount-row');
    const discountVal = document.getElementById('co-discount-val');
    const shippingVal = document.getElementById('co-shipping-val');
    const totalVal    = document.getElementById('co-total-val');
    const citySelect  = document.querySelector('select[name="billing_city"]');

    // Estado activo del cupón y envío
    let activeCoupon = null;
    let shippingAmount = 0;
    let shippingDays = '';

    function setFeedback(msg, type /* 'error' | 'success' */) {
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        feedback.innerHTML = `<div class="co-coupon-msg co-coupon-msg--${type}">
            <i class="fas ${icon}"></i><span>${msg}</span></div>`;
        feedback.style.display = 'block';
    }

    function clearFeedback() {
        feedback.style.display = 'none';
        feedback.innerHTML = '';
    }

    function showApplied(data) {
        appliedEl.innerHTML = `
            <div class="co-coupon-tag">
                <i class="fas fa-tag"></i>
                <span>${data.code} — ${data.label}</span>
                <button type="button" id="coupon-remove-btn" title="Quitar cupón">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        appliedEl.style.display = 'block';
        document.getElementById('coupon-remove-btn').addEventListener('click', removeCoupon);
    }

    function getDiscountAmount() {
        if (!activeCoupon) return 0;
        if (typeof activeCoupon.discount_amount === 'number') return activeCoupon.discount_amount;
        var m = (activeCoupon.discount || '').replace(/[^0-9]/g, '');
        return m ? parseInt(m, 10) : 0;
    }

    function updateGrandTotal() {
        var discount = getDiscountAmount();
        var total = CART_SUBTOTAL - discount + shippingAmount;
        totalVal.textContent = formatMoney(total);
    }

    function applyToSummary(data) {
        discountVal.textContent = '−' + data.discount;
        discountRow.style.display = '';
        updateGrandTotal();
    }

    function resetSummary() {
        discountRow.style.display = 'none';
        discountVal.textContent = '';
        updateGrandTotal();
    }

    function updateShippingDisplay(price, daysMin, daysMax, notFound, isFreeShipping) {
        if (isFreeShipping) {
            var freeDaysStr = '';
            if (daysMin != null && daysMax != null) {
                freeDaysStr = daysMin === daysMax ? (daysMin + ' d\u00eda' + (daysMin !== 1 ? 's' : '')) : (daysMin + ' a ' + daysMax + ' d\u00edas');
            }
            shippingVal.textContent = 'Gratis' + (freeDaysStr ? ' (' + freeDaysStr + ')' : '');
            return;
        }
        if (price === null && !notFound) {
            shippingVal.textContent = 'Selecciona ciudad';
            return;
        }
        if (notFound) {
            shippingVal.textContent = 'No configurado';
            return;
        }
        var daysStr = '';
        if (daysMin != null && daysMax != null) {
            daysStr = daysMin === daysMax ? (daysMin + ' d\u00eda' + (daysMin !== 1 ? 's' : '')) : (daysMin + ' a ' + daysMax + ' d\u00edas');
        }
        shippingVal.textContent = formatMoney(price) + (daysStr ? ' (' + daysStr + ')' : '');
    }

    function hasFreeShippingBySubtotal() {
        return FREE_SHIPPING_MIN > 0 && CART_SUBTOTAL >= FREE_SHIPPING_MIN;
    }

    function fetchShipping(cityId) {
        var freeShipping = hasFreeShippingBySubtotal();
        if (!cityId) {
            shippingAmount = 0;
            updateShippingDisplay(null, null, null, false, freeShipping);
            updateGrandTotal();
            return;
        }
        shippingVal.textContent = 'Cargando…';
        fetch(SHIPPING_URL + '?city_id=' + encodeURIComponent(cityId))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (freeShipping) {
                    shippingAmount = 0;
                    updateShippingDisplay(0, data.days_min, data.days_max, false, true);
                } else if (data.found) {
                    shippingAmount = parseFloat(data.price) || 0;
                    updateShippingDisplay(shippingAmount, data.days_min, data.days_max, false, false);
                } else {
                    shippingAmount = 0;
                    updateShippingDisplay(null, null, null, true, false);
                }
                updateGrandTotal();
            })
            .catch(function() {
                shippingAmount = 0;
                updateShippingDisplay(null, null, null, false, freeShipping);
                updateGrandTotal();
            });
    }

    function removeCoupon() {
        activeCoupon = null;
        inp.value = '';
        inp.disabled = false;
        applyBtn.disabled = false;
        appliedEl.style.display = 'none';
        appliedEl.innerHTML = '';
        document.getElementById('coupon-input-row').style.display = 'flex';
        document.getElementById('coupon-toggle-text').textContent = '¿Tienes un cupón?';
        clearFeedback();
        resetSummary();
        // Abrir panel
        couponBody.style.display = 'block';
        chevron.classList.add('open');
        inp.focus();
    }

    async function applyCoupon() {
        const code = inp.value.trim();
        if (!code) {
            setFeedback('Ingresa un código de cupón.', 'error');
            inp.focus();
            return;
        }

        // loading state
        applyBtn.classList.add('loading');
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Aplicar</span>';
        applyBtn.disabled = true;
        clearFeedback();

        try {
            const res  = await fetch(`${VALIDATE_URL}?code=${encodeURIComponent(code)}`);
            const data = await res.json();

            if (data.valid) {
                activeCoupon = data;
                // Ocultar input y mostrar tag
                document.getElementById('coupon-input-row').style.display = 'none';
                showApplied(data);
                applyToSummary(data);
                // Sincronizar con el campo del form
                inp.value = data.code;
                // Actualizar texto del toggle y colapsar
                document.getElementById('coupon-toggle-text').textContent = `Cupón: ${data.code}`;
                couponBody.style.display = 'none';
                chevron.classList.remove('open');
                if (window.showToast) showToast(`Cupón ${data.code} aplicado — ahorras ${data.discount}`, 'success');
            } else {
                setFeedback(data.error || 'Cupón no válido.', 'error');
                applyBtn.disabled = false;
            }
        } catch (e) {
            setFeedback('Error de conexión. Inténtalo de nuevo.', 'error');
            applyBtn.disabled = false;
        } finally {
            applyBtn.classList.remove('loading');
            applyBtn.innerHTML = '<span class="btn-text">Aplicar</span>';
        }
    }

    // Toggle expandir/colapsar cupón
    const toggleBtn  = document.getElementById('coupon-toggle-btn');
    const couponBody = document.getElementById('coupon-body');
    const chevron    = document.getElementById('coupon-chevron');

    toggleBtn.addEventListener('click', () => {
        const open = couponBody.style.display !== 'none';
        couponBody.style.display = open ? 'none' : 'block';
        chevron.classList.toggle('open', !open);
        if (!open) setTimeout(() => inp.focus(), 50);
    });

    applyBtn.addEventListener('click', applyCoupon);

    inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); applyCoupon(); }
    });

    // Envío: cargar precio al seleccionar ciudad
    function getCityIdFromSelect() {
        if (!citySelect) return null;
        var opt = citySelect.options[citySelect.selectedIndex];
        return opt ? opt.getAttribute('data-city-id') : null;
    }
    function onCityChange() {
        var cityId = getCityIdFromSelect();
        fetchShipping(cityId);
    }
    if (citySelect) {
        citySelect.addEventListener('change', onCityChange);
        // Cuando las ciudades se cargan (cascade), revisar si hay ciudad seleccionada
        citySelect.addEventListener('citiesLoaded', function() {
            if (citySelect.value) onCityChange();
        });
        // Fallback: después de cargar el DOM, si hay ciudad seleccionada
        setTimeout(function() {
            if (citySelect.value) onCityChange();
        }, 600);
    }
})();
</script>
{% endblock %}
