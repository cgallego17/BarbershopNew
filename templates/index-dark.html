{% extends 'base.html' %}
{% load static %}
{% block title %}{{ site_settings.site_name|default:"Inicio" }}{% endblock %}

{% block extra_preload %}
    {% with first_slide=hero_slides|first %}
        {% if first_slide and first_slide.image %}
            <link rel="preload" href="{{ first_slide.image.url }}" as="image">
        {% else %}
            <link rel="preload" href="{% static '1970-x-670-d.jpg' %}" as="image">
        {% endif %}
    {% endwith %}
{% endblock %}

{% block meta_description %}{{ site_settings.meta_description|default:site_settings.tagline|default:"Bienvenido a nuestra tienda de barbería online." }}{% endblock %}

{% block og_title %}{{ site_settings.site_name }} — Tu Barbería de Confianza{% endblock %}
{% block og_description %}{{ site_settings.tagline|default:"Los mejores productos para el cuidado personal." }}{% endblock %}

{% block extra_head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "{{ site_settings.site_name|default:'The Barbershop'|escapejs }}",
  "url": "{{ request.scheme }}://{{ request.get_host }}",
  "logo": "{% if site_settings.logo %}{{ request.scheme }}://{{ request.get_host }}{{ site_settings.logo.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'assets/images/logo-dark.png' %}{% endif %}"
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "{{ site_settings.site_name|default:'The Barbershop'|escapejs }}",
  "url": "{{ request.scheme }}://{{ request.get_host }}",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "{{ request.scheme }}://{{ request.get_host }}{% url 'products:list' %}?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% endblock %}

{% block content %}
{% if home_popup and home_popup.is_active and home_popup.content %}
<div class="modal fade" id="homeAnnouncementModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ home_popup.title|default:'Anuncio' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                {% if home_popup.image %}
                <div class="mb-3">
                    <img src="{{ home_popup.image.url }}" alt="{{ home_popup.title|default:'Anuncio' }}" class="img-fluid rounded">
                </div>
                {% endif %}
                <div class="rich-text">{{ home_popup.content|safe }}</div>
            </div>
            <div class="modal-footer">
                {% if home_popup.button_text and home_popup.button_url %}
                <a class="btn btn-primary" href="{{ home_popup.button_url }}">{{ home_popup.button_text }}</a>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% for section_key in active_sections %}
    {% if section_key == 'hero' %}
        {% include 'home/section_hero.html' %}
    {% elif section_key == 'about' and about_block.content %}
        {% include 'home/section_about.html' %}
    {% elif section_key == 'brands' and home_brands %}
        {% include 'home/section_brands.html' %}
    {% elif section_key == 'products' %}
        {% include 'home/section_products.html' %}
    {% elif section_key == 'meat_category' %}
        {% include 'home/section_meat_category.html' %}
    {% elif section_key == 'testimonials' and home_testimonials %}
        {% include 'home/section_testimonials.html' %}
    {% endif %}
{% endfor %}
{% endblock %}

{% block extra_js %}
{% if home_popup and home_popup.is_active and home_popup.content %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    try {
        var key = 'home_popup_seen_v1';
        if (window.localStorage && localStorage.getItem(key) === '1') {
            return;
        }
        var el = document.getElementById('homeAnnouncementModal');
        if (!el || !window.bootstrap) {
            return;
        }
        var modal = new bootstrap.Modal(el);
        modal.show();
        if (window.localStorage) {
            localStorage.setItem(key, '1');
        }
    } catch (e) {
        // no-op
    }
});
</script>
{% endif %}
{% endblock %}
